# üê≥ Gu√≠a de Despliegue con Docker - QuickTask API

Esta gu√≠a explica c√≥mo desplegar QuickTask API usando **Docker** y **Docker Compose**.

---

## üìã Tabla de Contenidos

1. [Requisitos Previos](#requisitos-previos)
2. [Archivos de Configuraci√≥n](#archivos-de-configuraci√≥n)
3. [Despliegue R√°pido](#despliegue-r√°pido)
4. [Modos de Despliegue](#modos-de-despliegue)
5. [Comandos Docker](#comandos-docker)
6. [Gesti√≥n de Datos](#gesti√≥n-de-datos)
7. [Troubleshooting](#troubleshooting)

---

## üîß Requisitos Previos

### Software Necesario

```bash
# Verificar instalaci√≥n de Docker
docker --version
# Docker version 24.0.0 o superior

# Verificar Docker Compose
docker-compose --version
# Docker Compose version 2.20.0 o superior
```

### Instalaci√≥n de Docker

#### Linux (Ubuntu/Debian)
```bash
# Actualizar repositorios
sudo apt-get update

# Instalar Docker
sudo apt-get install docker.io docker-compose

# Agregar usuario al grupo docker
sudo usermod -aG docker $USER

# Reiniciar sesi√≥n o ejecutar
newgrp docker
```

#### macOS
```bash
# Instalar Docker Desktop desde:
# https://www.docker.com/products/docker-desktop
```

#### Windows
```bash
# Instalar Docker Desktop desde:
# https://www.docker.com/products/docker-desktop
# Habilitar WSL 2
```

---

## üìÅ Archivos de Configuraci√≥n

### Archivos Creados

```
backend/
‚îú‚îÄ‚îÄ Dockerfile                 # Dockerfile b√°sico
‚îú‚îÄ‚îÄ Dockerfile.prod            # Dockerfile optimizado (producci√≥n)
‚îú‚îÄ‚îÄ docker-compose.yml         # Compose est√°ndar
‚îú‚îÄ‚îÄ docker-compose.dev.yml     # Compose con hot-reload
‚îú‚îÄ‚îÄ docker-compose.prod.yml    # Compose de producci√≥n
‚îú‚îÄ‚îÄ .dockerignore              # Archivos a ignorar
‚îî‚îÄ‚îÄ docker.sh                  # Script de gesti√≥n
```

### Descripci√≥n de Archivos

| Archivo | Prop√≥sito |
|---------|-----------|
| `Dockerfile` | Imagen Docker b√°sica para desarrollo |
| `Dockerfile.prod` | Imagen multi-stage optimizada |
| `docker-compose.yml` | Configuraci√≥n est√°ndar |
| `docker-compose.dev.yml` | Con auto-reload para desarrollo |
| `docker-compose.prod.yml` | Sin montaje de c√≥digo (producci√≥n) |
| `.dockerignore` | Excluir archivos innecesarios |
| `docker.sh` | Script helper para gesti√≥n |

---

## üöÄ Despliegue R√°pido

### Opci√≥n 1: Usando Docker Compose (Recomendado)

```bash
# 1. Navegar al directorio backend
cd backend

# 2. Levantar el contenedor
docker-compose up -d

# 3. Ver logs
docker-compose logs -f

# 4. Probar la API
curl http://localhost:8000/health
```

### Opci√≥n 2: Usando el Script Helper

```bash
# 1. Hacer ejecutable (primera vez)
chmod +x docker.sh

# 2. Levantar contenedor
./docker.sh up

# 3. Ver logs
./docker.sh logs

# 4. Ver estado
./docker.sh status
```

### Opci√≥n 3: Docker Manual

```bash
# 1. Construir imagen
docker build -t quicktask-api .

# 2. Ejecutar contenedor
docker run -d \
  --name quicktask-api \
  -p 8000:8000 \
  -v quicktask-data:/app/data \
  quicktask-api

# 3. Ver logs
docker logs -f quicktask-api
```

---

## üéØ Modos de Despliegue

### 1. Modo Desarrollo (con Hot-Reload)

**Caracter√≠sticas:**
- ‚úÖ Auto-reload cuando cambias c√≥digo
- ‚úÖ C√≥digo montado como volumen
- ‚úÖ BD de desarrollo separada
- ‚úÖ Debug habilitado

```bash
# Levantar
docker-compose -f docker-compose.dev.yml up -d

# Ver logs en tiempo real
docker-compose -f docker-compose.dev.yml logs -f

# Detener
docker-compose -f docker-compose.dev.yml down
```

**Ventajas:**
- üöÄ Cambios de c√≥digo se reflejan inmediatamente
- üêõ F√°cil debugging
- üìù No necesitas reconstruir la imagen

### 2. Modo Est√°ndar

**Caracter√≠sticas:**
- ‚úÖ Balance entre desarrollo y producci√≥n
- ‚úÖ C√≥digo montado (opcional)
- ‚úÖ Restart autom√°tico

```bash
# Levantar
docker-compose up -d

# Ver logs
docker-compose logs -f

# Detener
docker-compose down
```

### 3. Modo Producci√≥n

**Caracter√≠sticas:**
- ‚úÖ Imagen optimizada multi-stage
- ‚úÖ Usuario no-root (seguridad)
- ‚úÖ Sin montaje de c√≥digo
- ‚úÖ L√≠mites de recursos
- ‚úÖ Health checks configurados

```bash
# Levantar
docker-compose -f docker-compose.prod.yml up -d

# Ver estado
docker-compose -f docker-compose.prod.yml ps

# Detener
docker-compose -f docker-compose.prod.yml down
```

---

## üõ†Ô∏è Comandos Docker

### Gesti√≥n de Contenedores

```bash
# Levantar contenedor en background
docker-compose up -d

# Levantar y ver logs
docker-compose up

# Detener contenedor
docker-compose down

# Reiniciar contenedor
docker-compose restart

# Ver estado
docker-compose ps

# Ver logs (√∫ltimas 100 l√≠neas)
docker-compose logs --tail=100

# Seguir logs en tiempo real
docker-compose logs -f
```

### Construcci√≥n de Im√°genes

```bash
# Construir imagen
docker-compose build

# Reconstruir sin cach√©
docker-compose build --no-cache

# Construir y levantar
docker-compose up --build -d
```

### Ejecuci√≥n de Comandos

```bash
# Abrir shell en el contenedor
docker-compose exec quicktask-api /bin/bash

# Ejecutar comando espec√≠fico
docker-compose exec quicktask-api python --version

# Ejecutar tests
docker-compose exec quicktask-api pytest -v

# Ver variables de entorno
docker-compose exec quicktask-api env
```

### Gesti√≥n de Vol√∫menes

```bash
# Listar vol√∫menes
docker volume ls

# Inspeccionar volumen
docker volume inspect quicktask-sqlite-data

# Eliminar volumen (¬°CUIDADO! Borra datos)
docker volume rm quicktask-sqlite-data

# Backup de volumen
docker run --rm \
  -v quicktask-sqlite-data:/data \
  -v $(pwd):/backup \
  busybox tar czf /backup/quicktask-backup.tar.gz -C /data .
```

---

## üíæ Gesti√≥n de Datos

### Persistencia de la Base de Datos

La base de datos SQLite se almacena en un **volumen Docker nombrado**:

```yaml
volumes:
  quicktask-data:
    driver: local
    name: quicktask-sqlite-data
```

**Ubicaci√≥n en el contenedor:** `/app/data/quicktask.db`

### Backup de Datos

#### M√©todo 1: Backup Manual
```bash
# Crear backup
docker-compose exec quicktask-api cp /app/data/quicktask.db /app/data/quicktask-backup.db

# Copiar backup al host
docker cp quicktask-api:/app/data/quicktask-backup.db ./backup.db
```

#### M√©todo 2: Backup de Volumen
```bash
# Crear backup comprimido
docker run --rm \
  -v quicktask-sqlite-data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/db-backup-$(date +%Y%m%d).tar.gz -C /data .
```

### Restaurar Datos

```bash
# Desde archivo de backup
docker cp ./backup.db quicktask-api:/app/data/quicktask.db

# Reiniciar contenedor
docker-compose restart
```

### Limpiar Datos

```bash
# Detener y eliminar contenedor + volumen
docker-compose down -v

# Solo eliminar volumen (mantener contenedor)
docker volume rm quicktask-sqlite-data
```

---

## üß™ Probar la API

### 1. Health Check

```bash
# Verificar que la API est√° funcionando
curl http://localhost:8000/health

# Respuesta esperada:
# {"status":"healthy","service":"QuickTask API"}
```

### 2. Documentaci√≥n Interactiva

Abrir en el navegador:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### 3. Crear una Tarea

```bash
curl -X POST "http://localhost:8000/tasks" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Tarea desde Docker",
    "description": "Probando la API en contenedor",
    "completed": false
  }'
```

### 4. Listar Tareas

```bash
curl http://localhost:8000/tasks
```

### 5. Script de Test Completo

```bash
#!/bin/bash

echo "üß™ Probando QuickTask API en Docker..."

# 1. Health check
echo -e "\n1Ô∏è‚É£ Health Check:"
curl -s http://localhost:8000/health | jq

# 2. Crear tarea
echo -e "\n2Ô∏è‚É£ Crear tarea:"
TASK=$(curl -s -X POST "http://localhost:8000/tasks" \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Docker","description":"Tarea de prueba"}')
echo $TASK | jq

# 3. Obtener ID de la tarea
TASK_ID=$(echo $TASK | jq -r '.id')
echo "ID de tarea creada: $TASK_ID"

# 4. Listar tareas
echo -e "\n3Ô∏è‚É£ Listar tareas:"
curl -s http://localhost:8000/tasks | jq

# 5. Marcar como completada
echo -e "\n4Ô∏è‚É£ Marcar como completada:"
curl -s -X PATCH "http://localhost:8000/tasks/$TASK_ID" \
  -H "Content-Type: application/json" \
  -d '{"completed":true}' | jq

echo -e "\n‚úÖ Test completado"
```

---

## üìä Monitoreo

### Ver Recursos Usados

```bash
# Ver uso de CPU, memoria y red
docker stats quicktask-api

# Ver uso de forma continua
docker stats --no-stream quicktask-api
```

### Health Check Status

```bash
# Ver estado de health check
docker inspect --format='{{.State.Health.Status}}' quicktask-api

# Ver logs de health check
docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' quicktask-api
```

### Logs Detallados

```bash
# √öltimos 50 logs
docker-compose logs --tail=50 quicktask-api

# Solo errores
docker-compose logs quicktask-api | grep -i error

# Logs con timestamp
docker-compose logs -t quicktask-api
```

---

## üêõ Troubleshooting

### Problema: Puerto 8000 ya en uso

```bash
# Ver qu√© proceso usa el puerto
sudo lsof -i :8000

# O cambiar el puerto en docker-compose.yml:
ports:
  - "8080:8000"  # Puerto host:contenedor
```

### Problema: Contenedor no inicia

```bash
# Ver logs de error
docker-compose logs quicktask-api

# Ver eventos
docker events --since 1h

# Inspeccionar contenedor
docker inspect quicktask-api
```

### Problema: Base de datos corrupta

```bash
# Detener contenedor
docker-compose down

# Eliminar volumen
docker volume rm quicktask-sqlite-data

# Volver a levantar
docker-compose up -d
```

### Problema: Cambios en c√≥digo no se reflejan

```bash
# Reconstruir imagen
docker-compose up --build -d

# O usar modo desarrollo con hot-reload
docker-compose -f docker-compose.dev.yml up -d
```

### Problema: Permisos en Linux

```bash
# Agregar usuario al grupo docker
sudo usermod -aG docker $USER

# Reiniciar sesi√≥n
newgrp docker

# Verificar
docker ps
```

---

## üéØ Comandos Usando el Script Helper

El script `docker.sh` simplifica la gesti√≥n:

```bash
# Ver ayuda
./docker.sh help

# Construir imagen
./docker.sh build

# Levantar (desarrollo)
./docker.sh up

# Levantar (producci√≥n)
./docker.sh up-prod

# Ver logs
./docker.sh logs

# Ver estado
./docker.sh status

# Abrir shell
./docker.sh shell

# Ejecutar tests
./docker.sh test

# Reiniciar
./docker.sh restart

# Detener
./docker.sh down

# Limpiar todo
./docker.sh clean
```

---

## üìù Resumen de Pasos

### Despliegue Inicial

```bash
# 1. Clonar/navegar al proyecto
cd backend

# 2. Construir imagen
docker-compose build

# 3. Levantar contenedor
docker-compose up -d

# 4. Verificar
curl http://localhost:8000/health

# 5. Abrir documentaci√≥n
open http://localhost:8000/docs
```

### Desarrollo Diario

```bash
# Levantar con hot-reload
docker-compose -f docker-compose.dev.yml up -d

# Ver logs
docker-compose logs -f

# Ejecutar tests
docker-compose exec quicktask-api pytest

# Detener
docker-compose down
```

### Despliegue a Producci√≥n

```bash
# 1. Construir imagen optimizada
docker-compose -f docker-compose.prod.yml build

# 2. Levantar
docker-compose -f docker-compose.prod.yml up -d

# 3. Verificar estado
docker-compose -f docker-compose.prod.yml ps

# 4. Monitorear
docker stats quicktask-api-prod
```

---

## üåü Mejores Pr√°cticas

### Desarrollo
- ‚úÖ Usar `docker-compose.dev.yml` con hot-reload
- ‚úÖ Montar c√≥digo como volumen
- ‚úÖ Usar BD de desarrollo separada
- ‚úÖ Ver logs en tiempo real

### Producci√≥n
- ‚úÖ Usar `Dockerfile.prod` multi-stage
- ‚úÖ No montar c√≥digo
- ‚úÖ Configurar health checks
- ‚úÖ Establecer l√≠mites de recursos
- ‚úÖ Usar usuario no-root
- ‚úÖ Hacer backups regulares

### Seguridad
- ‚úÖ No exponer puertos innecesarios
- ‚úÖ Usar secrets para credenciales
- ‚úÖ Mantener im√°genes actualizadas
- ‚úÖ Escanear vulnerabilidades

---

## üìö Recursos Adicionales

- [Docker Docs](https://docs.docker.com/)
- [Docker Compose Docs](https://docs.docker.com/compose/)
- [FastAPI Docker](https://fastapi.tiangolo.com/deployment/docker/)
- [Best Practices](https://docs.docker.com/develop/dev-best-practices/)

---

**üê≥ QuickTask API dockerizada y lista para desplegar!** üöÄ
